#!/usr/bin/env bash
# Migrate .claude configurations to OpenCode format
# - Renames CLAUDE.md to AGENTS.md
# - Copies .claude/ folder contents to .opencode/
# - Transforms agent file frontmatter from Claude to OpenCode format

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Default to current directory if no argument provided
TARGET_DIR="${1:-.}"

# Resolve to absolute path
TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

log_info "Migrating Claude config to OpenCode in: $TARGET_DIR"

# Model alias to full path mapping
declare -A MODEL_MAP=(
    ["sonnet"]="anthropic/claude-sonnet-4-20250514"
    ["opus"]="anthropic/claude-opus-4-20250514"
    ["haiku"]="anthropic/claude-haiku-3-5-20241022"
)

# All known tools for boolean mapping
ALL_TOOLS="read write edit bash glob grep task webfetch websearch"

# Function to convert Claude agent format to OpenCode format
convert_agent_file() {
    local file="$1"
    local temp_file="${file}.tmp"

    # Check if file has YAML frontmatter
    if ! head -1 "$file" | grep -q '^---$'; then
        return 0
    fi

    log_info "Converting agent file: $file"

    # Extract frontmatter and body
    local frontmatter body in_frontmatter=true frontmatter_end=0
    frontmatter=""
    body=""

    while IFS= read -r line || [[ -n "$line" ]]; do
        if [[ $frontmatter_end -eq 0 && "$line" == "---" ]]; then
            if [[ -z "$frontmatter" ]]; then
                continue  # Skip opening ---
            else
                frontmatter_end=1
                continue  # Skip closing ---
            fi
        fi

        if [[ $frontmatter_end -eq 0 ]]; then
            frontmatter+="$line"$'\n'
        else
            body+="$line"$'\n'
        fi
    done < "$file"

    # Parse Claude format fields
    local description="" tools_list="" model_alias=""

    description=$(echo "$frontmatter" | grep -E '^description:' | sed 's/^description:[[:space:]]*//' || true)
    tools_list=$(echo "$frontmatter" | grep -E '^tools:' | sed 's/^tools:[[:space:]]*//' | sed 's/#.*//' | tr -d ' ' || true)
    model_alias=$(echo "$frontmatter" | grep -E '^model:' | sed 's/^model:[[:space:]]*//' | tr -d ' ' || true)

    # Build OpenCode format
    {
        echo "---"

        # Description (required)
        if [[ -n "$description" ]]; then
            echo "description: $description"
        else
            echo "description: Migrated from Claude Code"
        fi

        # Mode is always subagent for .claude agents
        echo "mode: subagent"

        # Model mapping
        if [[ -n "$model_alias" && "$model_alias" != "inherit" ]]; then
            local full_model="${MODEL_MAP[$model_alias]:-$model_alias}"
            echo "model: $full_model"
        fi

        # Tools as boolean map
        if [[ -n "$tools_list" ]]; then
            echo "tools:"
            # Convert comma-separated list to array
            IFS=',' read -ra enabled_tools <<< "$tools_list"

            # Create associative array of enabled tools
            declare -A enabled_map
            for tool in "${enabled_tools[@]}"; do
                enabled_map["$tool"]=1
            done

            # Output all tools with their enabled status
            for tool in $ALL_TOOLS; do
                if [[ -n "${enabled_map[$tool]:-}" ]]; then
                    echo "  $tool: true"
                else
                    echo "  $tool: false"
                fi
            done
        fi

        echo "---"

        # Append body content
        echo -n "$body"
    } > "$temp_file"

    mv "$temp_file" "$file"
}

# Function to migrate a single directory
migrate_directory() {
    local dir="$1"
    local claude_md="$dir/CLAUDE.md"
    local agents_md="$dir/AGENTS.md"
    local claude_dir="$dir/.claude"
    local opencode_dir="$dir/.opencode"

    # Migrate CLAUDE.md -> AGENTS.md
    if [[ -f "$claude_md" ]]; then
        if [[ -f "$agents_md" ]]; then
            log_info "Overwriting AGENTS.md with CLAUDE.md in $dir"
            rm -f "$agents_md"
        fi
        log_info "Renaming CLAUDE.md -> AGENTS.md in $dir"
        mv "$claude_md" "$agents_md"
    fi

    # Migrate .claude/ -> .opencode/
    if [[ -d "$claude_dir" ]]; then
        if [[ -d "$opencode_dir" ]]; then
            log_info "Removing existing .opencode/ in $dir"
            rm -rf "$opencode_dir"
        fi
        log_info "Copying .claude/ -> .opencode/ in $dir"
        cp -r "$claude_dir" "$opencode_dir"

        # Convert all .md files in the new .opencode directory
        find "$opencode_dir" -type f -name "*.md" | while read -r agent_file; do
            convert_agent_file "$agent_file"
        done
    fi
}

# Migrate root directory
migrate_directory "$TARGET_DIR"

# Find and migrate all subdirectories containing .claude or CLAUDE.md
find "$TARGET_DIR" -type f -name "CLAUDE.md" -o -type d -name ".claude" 2>/dev/null | while read -r path; do
    if [[ -f "$path" ]]; then
        # It's CLAUDE.md, get parent directory
        parent_dir="$(dirname "$path")"
    else
        # It's .claude directory, get parent
        parent_dir="$(dirname "$path")"
    fi
    
    # Skip if it's the root (already processed)
    if [[ "$parent_dir" != "$TARGET_DIR" ]]; then
        migrate_directory "$parent_dir"
    fi
done

log_info "Migration complete!"
log_info "You may want to:"
echo "  - Review the migrated files"
echo "  - Remove old .claude folders: find . -name '.claude' -type d -exec rm -rf {} +"
echo "  - Update any references to CLAUDE.md in your codebase"
